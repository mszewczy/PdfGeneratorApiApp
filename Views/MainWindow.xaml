<Window x:Class="PdfGeneratorApiApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:viewModels="clr-namespace:PdfGeneratorApiApp.ViewModels"
        xmlns:models="clr-namespace:PdfGeneratorApiApp.Models"
        xmlns:converters="clr-namespace:PdfGeneratorApiApp.Converters"
        xmlns:syncfusion="clr-namespace:Syncfusion.Windows.PdfViewer;assembly=Syncfusion.PdfViewer.WPF"
        xmlns:dd="urn:gong-wpf-dragdrop" 
        mc:Ignorable="d"
        Title="PDF Generator (DynamicPDF.API)" Height="800" Width="1200"
        Closing="Window_Closing">
    <Window.DataContext>
        <viewModels:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InvertBooleanConverter x:Key="InvertBooleanConverter"/>

        <HierarchicalDataTemplate DataType="{x:Type models:TocItem}" ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal">
                <Grid>
                    <!-- Widok do wyświetlania -->
                    <TextBlock Text="{Binding DisplayText}" FontWeight="SemiBold" VerticalAlignment="Center" Visibility="{Binding IsEditing, Converter={StaticResource InvertBooleanConverter}}"/>
                    <!-- Widok do edycji -->
                    <TextBox Text="{Binding DisplayText, UpdateSourceTrigger=PropertyChanged}" MinWidth="150" Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Enter" Command="{Binding DataContext.EndEditItemCommand, RelativeSource={RelativeSource AncestorType=TreeView}}" CommandParameter="{Binding}"/>
                            <KeyBinding Key="Escape" Command="{Binding DataContext.EndEditItemCommand, RelativeSource={RelativeSource AncestorType=TreeView}}" CommandParameter="{Binding}"/>
                        </TextBox.InputBindings>
                    </TextBox>
                </Grid>
                <TextBlock Text="{Binding Url, StringFormat=' ({0})'}" FontStyle="Italic" Foreground="Gray" Margin="5,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
        </HierarchicalDataTemplate>

        <Style TargetType="TreeViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
            <Setter Property="dd:DragDrop.IsDragSource" Value="True"/>
            <Setter Property="dd:DragDrop.IsDropTarget" Value="True"/>
            <Setter Property="AllowDrop" Value="True"/>
        </Style>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="450" MinWidth="300"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Lewy panel z drzewem i opcjami -->
        <DockPanel Grid.Column="0" Margin="0,0,10,0">
            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="Hierarchia Spisu Treści" FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>
                <Button Content="Otwórz PDF" Command="{Binding OpenPdfCommand}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                <TextBlock Text="*" Foreground="Red" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" Margin="5,0,0,0"
                           Visibility="{Binding IsDirty, Converter={StaticResource BooleanToVisibilityConverter}}"
                           ToolTip="Niezapisane zmiany"/>
            </StackPanel>

            <!-- Panel dolny z przyciskami i opcjami -->
            <StackPanel DockPanel.Dock="Bottom" Margin="0,10,0,0">
                <GroupBox Header="Dodaj nowy element (poziom główny)" Padding="5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="URL:" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBox Text="{Binding NewItemUrl, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1" Margin="0,2"/>

                        <TextBlock Text="Opis:" Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBox Text="{Binding NewItemDisplayText, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Margin="0,2"/>

                        <Button Content="Dodaj" Command="{Binding AddItemCommand}" Grid.Row="0" Grid.Column="2" Grid.RowSpan="2" VerticalAlignment="Center" Margin="5,0,0,0" Padding="10,5"/>
                    </Grid>
                </GroupBox>

                <GroupBox Header="Operacje na zaznaczonym elemencie" Padding="5" Margin="0,10,0,0">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="Dodaj Pod-element" Command="{Binding AddSubItemCommand}" Margin="5"/>
                        <Button Content="Edytuj" Command="{Binding StartEditItemCommand}" Margin="5"/>
                        <Button Content="Usuń" Command="{Binding RemoveItemCommand}" Margin="5"/>
                    </StackPanel>
                </GroupBox>

                <GroupBox Header="Opcje generowania" Padding="5" Margin="0,15,0,0">
                    <StackPanel>
                        <CheckBox Content="Generuj spis treści (zakładki)" IsChecked="{Binding AddToc}" Margin="0,0,0,10"/>
                        <CheckBox Content="Dołącz tabelę kodów QR dla linków" IsChecked="{Binding GenerateQrCodeTable}" Margin="0,0,0,10"/>
                        <StackPanel IsEnabled="{Binding AddToc}">
                            <RadioButton Content="Spis treści na początku dokumentu" IsChecked="{Binding IsTocAtStart, Mode=TwoWay}" GroupName="TocPosition"/>
                            <RadioButton Content="Spis treści na końcu dokumentu" IsChecked="{Binding IsTocAtStart, Converter={StaticResource InvertBooleanConverter}}" GroupName="TocPosition"/>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>
                <Button Content="Generuj PDF" Command="{Binding GeneratePdfAsyncCommand}" IsEnabled="{Binding IsGenerating, Converter={StaticResource InvertBooleanConverter}}" FontWeight="Bold" Padding="10" Margin="0,20,0,0"/>
                <ProgressBar IsIndeterminate="True" Height="10" Margin="0,5,0,0" Visibility="{Binding IsGenerating, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>

            <!-- Drzewo spisu treści -->
            <TreeView ItemsSource="{Binding TocItems}"
                      SelectedItemChanged="TreeView_SelectedItemChanged"
                      dd:DragDrop.DropHandler="{Binding}"
                      dd:DragDrop.UseDefaultEffectDataTemplate="True"/>
        </DockPanel>

        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="LightGray"/>

        <!-- Prawy panel z podglądem PDF -->
        <Border Grid.Column="2" BorderBrush="LightGray" BorderThickness="1">
            <syncfusion:PdfViewerControl x:Name="pdfViewer"
                                          ItemSource="{Binding PdfDocumentStream}"/>
        </Border>
    </Grid>
</Window>
